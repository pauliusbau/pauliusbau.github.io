<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Paulius Bautrėnas - Programavimas</title><link href="https://paulius.bautrenas.lt/" rel="alternate"></link><link href="https://paulius.bautrenas.lt/feeds/programavimas.atom.xml" rel="self"></link><id>https://paulius.bautrenas.lt/</id><updated>2015-04-29T14:20:00+03:00</updated><subtitle>#define TRUE FALSE</subtitle><entry><title>Flip-Dot Clock laiko sinchronizavimas su Aviete per Bluetooth</title><link href="https://paulius.bautrenas.lt/flip-dot-clock-laiko-sinchronizavimas-su-aviete-per-bluetooth.html" rel="alternate"></link><published>2015-04-29T14:20:00+03:00</published><updated>2015-04-29T14:20:00+03:00</updated><author><name>pauliusbau</name></author><id>tag:paulius.bautrenas.lt,2015-04-29:/flip-dot-clock-laiko-sinchronizavimas-su-aviete-per-bluetooth.html</id><summary type="html">&lt;p&gt;&lt;a class="reference external image-reference" href="https://paulius.bautrenas.lt/images/flip-dot-clock-laiko-sinchronizavimas-su-aviete-per-bluetooth/flip-dot-clock-synch.png"&gt;&lt;img alt="flip-dot clock synch" class="aligncenter size-full wp-image-752" src="https://paulius.bautrenas.lt/images/flip-dot-clock-laiko-sinchronizavimas-su-aviete-per-bluetooth/flip-dot-clock-synch.png" style="width: 571px; height: 264px;" /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Persukdamas savo &lt;a class="reference external" href="flip-dot-clock"&gt;elektromechaninį laikrodį&lt;/a&gt; į vasaros laiką, pastebėjau, kad laikrodis skuba daugiau nei viena minute. Kadangi laikrodis surinktas kreivai - šleivai, gali būti, kad RTC veikimą įtakoja kokia nors elektromagnetinė interferencija ar pan. Per daug į tai gilintis patingėjau, nes prisiminiau, kad prie laikrodžio kaip tyčia yra prijungtas&amp;nbsp;&lt;a class="reference external" href="http://paulius.bautrenas.lt/blog/?p=493"&gt;HC05 BlueTooth moduliukas …&lt;/a&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;a class="reference external image-reference" href="https://paulius.bautrenas.lt/images/flip-dot-clock-laiko-sinchronizavimas-su-aviete-per-bluetooth/flip-dot-clock-synch.png"&gt;&lt;img alt="flip-dot clock synch" class="aligncenter size-full wp-image-752" src="https://paulius.bautrenas.lt/images/flip-dot-clock-laiko-sinchronizavimas-su-aviete-per-bluetooth/flip-dot-clock-synch.png" style="width: 571px; height: 264px;" /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Persukdamas savo &lt;a class="reference external" href="flip-dot-clock"&gt;elektromechaninį laikrodį&lt;/a&gt; į vasaros laiką, pastebėjau, kad laikrodis skuba daugiau nei viena minute. Kadangi laikrodis surinktas kreivai - šleivai, gali būti, kad RTC veikimą įtakoja kokia nors elektromagnetinė interferencija ar pan. Per daug į tai gilintis patingėjau, nes prisiminiau, kad prie laikrodžio kaip tyčia yra prijungtas&amp;nbsp;&lt;a class="reference external" href="http://paulius.bautrenas.lt/blog/?p=493"&gt;HC05 BlueTooth moduliukas&lt;/a&gt;, kuris leidžia laikrodžio laiką atnaujinti nuotoliu būdu, o tai yra puiki galimybė laiko neatitikimą nuo realybės išspręsti reguliaria laiko sinchronizacija su RPI, kuri savo ruožtu laiką gauna iš NTP serverio.&lt;/p&gt;
&lt;div class="section" id="pasiruosimas"&gt;
&lt;h2&gt;Pasiruošimas&lt;/h2&gt;
&lt;p&gt;Įkišam USB Bluetooth adapterį į RPI ir terminale įvykdome šias komandas:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;update
sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;bluetooth&lt;span class="w"&gt; &lt;/span&gt;bluez-utils&lt;span class="w"&gt; &lt;/span&gt;blueman
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Įvykdytos komandos sudiegs visą bendravimui su bluetooth adapteriu reikalingą programinę įrangą. Norint įsitikinti, kad bluetooth modulis susidiegė teisingai, galima įvykdyti šią komandą:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;hciconfig
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Turėtume pamatyti kažką panašaus į:&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external image-reference" href="https://paulius.bautrenas.lt/images/flip-dot-clock-laiko-sinchronizavimas-su-aviete-per-bluetooth/hciconfig.png"&gt;&lt;img alt="hciconfig" class="aligncenter size-full wp-image-764" src="https://paulius.bautrenas.lt/images/flip-dot-clock-laiko-sinchronizavimas-su-aviete-per-bluetooth/hciconfig.png" style="width: 621px; height: 111px;" /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Įsitikinti, ar bluetooth veikia galima ir taip:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/bluetooth&lt;span class="w"&gt; &lt;/span&gt;status
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Beje, tokiu pat būdu, iškilus poreikiui, galima sustabdyti, paleisti ir perkrauti bluetooth komunikatorių. Tam komandoje žodį &amp;quot;&lt;em&gt;status&lt;/em&gt;&amp;quot;, atitinkamai, reiktų keisti &amp;quot;s&lt;em&gt;tart&amp;quot;&lt;/em&gt;, &amp;quot;&lt;em&gt;stop&amp;quot;&lt;/em&gt;, &amp;quot;&lt;em&gt;restart&amp;quot;&lt;/em&gt;&amp;nbsp;ar &amp;quot;&lt;em&gt;force-reload&lt;/em&gt;&amp;quot;.&lt;/p&gt;
&lt;p&gt;Jeigu bluetooth modulis veikia tvarkingai, galima susirasti aplinkinius įrenginius su komanda:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;hcitool&lt;span class="w"&gt; &lt;/span&gt;scan
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a class="reference external image-reference" href="https://paulius.bautrenas.lt/images/flip-dot-clock-laiko-sinchronizavimas-su-aviete-per-bluetooth/hcitool_scan.png"&gt;&lt;img alt="hcitool_scan" class="aligncenter size-full wp-image-766" src="https://paulius.bautrenas.lt/images/flip-dot-clock-laiko-sinchronizavimas-su-aviete-per-bluetooth/hcitool_scan.png" style="width: 474px; height: 82px;" /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Įrenginių sąraše turėtų matytis mus dominantis įrenginys. Norint su juo bendrauti, bluetooth įrenginius reikia suporuoti (angl. &lt;em&gt;pair&lt;/em&gt;) su komanda:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;bluez-simple-agent&lt;span class="w"&gt; &lt;/span&gt;hci0&lt;span class="w"&gt; &lt;/span&gt;xx:xx:xx:xx:xx:xx
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Savaime suprantama, vietoje &lt;em&gt;xx:xx:xx:xx:xx:xx&lt;/em&gt;&amp;nbsp;reiktų nurodyti savo pasirinkto bluetooth įrenginio MAC adresą. Įvykdžius komandą bei teisingai įvedus įrenginio slaptažodį (PIN kodą), įrenginiai turėtų susiporuoti ir būti pasiruošę tiesioginiam bendravimui. Norint su įrenginiu bendrauti nuosekliuoju protokolu (USART), reikia suderinti&amp;nbsp;RFCOMM protokolo nustatymus:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;nano&lt;span class="w"&gt; &lt;/span&gt;/etc/bluetooth/rfcomm.conf
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Faile reikia paredaguoti šias eilutes, įrašant į atitinkamą vietą savo pasirinkto bluetooth įrenginio MAC adresą:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;rfcomm1&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="nb"&gt;bind&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;yes&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;   &lt;/span&gt;device&lt;span class="w"&gt; &lt;/span&gt;xx:xx:xx:xx:xx:xx&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;   &lt;/span&gt;channel&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;   &lt;/span&gt;comment&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Connection to Bluetooth serial module&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Išsaugojus failą, įvykdome komandą, kuri sukurs virtualų nuoseklųjį prievadą (angl. &lt;em&gt;serial port&lt;/em&gt;) &lt;strong&gt;/dev/rfcomm1&lt;/strong&gt;, per kurį bus galima bendrauti su pasirinktu įrenginiu, mano atveju su &lt;a class="reference external" href="flip-dot-clock"&gt;flip-dot laikrodžiu&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;rfcomm&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;bind&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;all
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Pasiruošimas kaip ir baigtas, liko tik susidiegti &lt;a class="reference external" href="https://github.com/pyserial/pyserial"&gt;pySerial&lt;/a&gt; biblioteką, kuri leis siųsti ir priimti duomenis nuosekliuoju prievadu.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;python-serial
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="python-skriptas"&gt;
&lt;h2&gt;Python skriptas&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external image-reference" href="https://paulius.bautrenas.lt/images/flip-dot-clock-laiko-sinchronizavimas-su-aviete-per-bluetooth/flip-dot_synch.png"&gt;&lt;img alt="flip-dot_synch" class="aligncenter size-large wp-image-754" src="https://paulius.bautrenas.lt/images/flip-dot-clock-laiko-sinchronizavimas-su-aviete-per-bluetooth/flip-dot_synch-1024x426.png" style="width: 625px; height: 260px;" /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Po ilgų išieškojimų gavosi štai toks nepadoriai ilgas python skriptas (veikimo diagrama viršuje), kurio naujausią versiją rasite &lt;a class="reference external" href="https://github.com/pauliusbau/raspberrypi-mayhem/tree/master/RPI-bluetoothTimeSynch"&gt;mano GitHub saugykloje&lt;/a&gt;!&lt;/p&gt;
&lt;p&gt;Skirptas gavosi toks ilgas todėl, kad jis &lt;a class="reference external" href="flip-dot-clock"&gt;laikrodžio&lt;/a&gt; laiką ir datą atnaujina ne aklai, tačiau tik tada, kai to reikia, t. y. kai laikrodžio laikas nesutampa su RPI laiku per&amp;nbsp;&lt;em&gt;max_seconds_diff = 20&lt;/em&gt; sekundžių. Tam teko realizuoti aibę visokių papildomų patikrinimų ir apsaugų nuo timeout'ų ir blogo suveikimo. Taip pat skripte realizavau ir logo rašymą į failą &lt;em&gt;flip-dot_synch.log&lt;/em&gt;, kuris&amp;nbsp;labai praverčia skriptą leidžiant cron priemonėmis:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;30&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;,4&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;python&lt;span class="w"&gt; &lt;/span&gt;/home/python/flip-dot_synch.py&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;&amp;amp;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Beje, sukurtus logus terminale patogu skaityti su komanda &amp;quot;tail&amp;quot;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;tail&lt;span class="w"&gt; &lt;/span&gt;/home/python/flip-dot_synch.log
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a class="reference external image-reference" href="https://paulius.bautrenas.lt/images/flip-dot-clock-laiko-sinchronizavimas-su-aviete-per-bluetooth/flipdot_synch_log.png"&gt;&lt;img alt="flipdot_synch_log" class="aligncenter size-full wp-image-773" src="https://paulius.bautrenas.lt/images/flip-dot-clock-laiko-sinchronizavimas-su-aviete-per-bluetooth/flipdot_synch_log.png" style="width: 675px; height: 408px;" /&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="naudinga-literatura"&gt;
&lt;h2&gt;Naudinga literatūra:&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.uugear.com/portfolio/bluetooth-communication-between-raspberry-pi-and-arduino/"&gt;http://www.uugear.com/portfolio/bluetooth-communication-between-raspberry-pi-and-arduino/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.modmypi.com/blog/installing-the-raspberry-pi-nano-bluetooth-dongle"&gt;http://www.modmypi.com/blog/installing-the-raspberry-pi-nano-bluetooth-dongle&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://blog.davidvassallo.me/2014/05/11/android-linux-raspberry-pi-bluetooth-communication/"&gt;http://blog.davidvassallo.me/2014/05/11/android-linux-raspberry-pi-bluetooth-communication/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://stackoverflow.com/questions/19908167/reading-serial-data-in-realtime-in-python"&gt;http://stackoverflow.com/questions/19908167/reading-serial-data-in-realtime-in-python&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.roman10.net/serial-port-communication-in-python/#comments"&gt;http://www.roman10.net/serial-port-communication-in-python/#comments&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="http://www.regexr.com"&gt;http://www.regexr.com&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://regex101.com/#python"&gt;https://regex101.com/#python&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="Programavimas"></category><category term="bluetooth"></category><category term="clock"></category><category term="date"></category><category term="flip-dot"></category><category term="Python"></category><category term="python serial"></category><category term="RaspberriPi"></category><category term="regexp"></category><category term="RPI"></category><category term="synch"></category><category term="synchronization"></category><category term="time"></category></entry></feed>